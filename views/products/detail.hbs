{{#section 'style'}}
<style>
  .detail-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  .detail-header {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f0f0f0;
  }
  .detail-row {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f5f5f5;
  }
  .detail-row:last-child {
    border-bottom: none;
  }
  .detail-label {
    font-weight: 600;
    color: #6c757d;
  }
  .detail-value {
    color: #333;
  }
  .warranty-badge {
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.875rem;
  }
  .warranty-active {
    background: #d4edda;
    color: #155724;
  }
  .warranty-expired {
    background: #f8d7da;
    color: #721c24;
  }
  .warranty-void {
    background: #ffc107;
    color: #856404;
  }
  .warranty-none {
    background: #e9ecef;
    color: #6c757d;
  }
  .action-btn {
    margin-right: 0.5rem;
  }
</style>
{{/section}}

<div class="page-header mb-4">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="mb-0">Product Details</h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="/products">Products</a></li>
          <li class="breadcrumb-item active">{{product.name}}</li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <a href="/products/{{product._id}}/edit" class="btn btn-primary action-btn">
        <i class="bi bi-pencil me-2"></i>Edit
      </a>
      <button class="btn btn-warning action-btn" onclick="showWarrantyModal()">
        <i class="bi bi-shield-check me-2"></i>Warranty
      </button>
      <a href="/products" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back
      </a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <!-- Product Information -->
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-box me-2"></i>Product Information</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Serial Number:</span><br>
            <span class="detail-value fs-5 font-monospace">{{product.serialNumber}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Product Name:</span><br>
            <span class="detail-value fs-5">{{product.name}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Product Type:</span><br>
            <span class="detail-value">{{product.productType}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Capacity:</span><br>
            <span class="detail-value">{{product.typeCapacity}} GB</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Platform:</span><br>
            <span class="detail-value">
              {{#if product.platform}}
                <span class="badge bg-primary fs-6">{{capitalize product.platform}}</span>
              {{else}}
                <span class="badge bg-secondary fs-6">Unknown</span>
              {{/if}}
            </span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Source:</span><br>
            <span class="detail-value">
              {{#if product.source}}
                <span class="badge bg-success fs-6">{{product.source}}</span>
              {{else}}
                <span class="badge bg-light text-dark fs-6">Not Set</span>
              {{/if}}
            </span>
          </div>
        </div>
        <div class="col-12">
          <div class="detail-row">
            <span class="detail-label">Description:</span><br>
            <span class="detail-value">{{#if product.description}}{{product.description}}{{else}}<em>No description</em>{{/if}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Add Date:</span><br>
            <span class="detail-value">{{formatDate product.addDate}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Sold Date:</span><br>
            <span class="detail-value">{{#if product.soldDate}}{{formatDate product.soldDate}}{{else}}<em>Not sold</em>{{/if}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Buyer Information -->
    {{#if product.buyer.name}}
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-person me-2"></i>Buyer Information</h5>
      <div class="row">
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Name:</span><br>
            <span class="detail-value">{{product.buyer.name}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Phone:</span><br>
            <span class="detail-value">{{#if product.buyer.phone}}{{product.buyer.phone}}{{else}}<em>Not provided</em>{{/if}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Email:</span><br>
            <span class="detail-value">{{#if product.buyer.email}}{{product.buyer.email}}{{else}}<em>Not provided</em>{{/if}}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-row">
            <span class="detail-label">Payment Method:</span><br>
            <span class="detail-value">{{#if product.buyer.paymentMethod}}{{product.buyer.paymentMethod}}{{else}}<em>Not provided</em>{{/if}}</span>
          </div>
        </div>
        <div class="col-12">
          <div class="detail-row">
            <span class="detail-label">Address:</span><br>
            <span class="detail-value">{{#if product.buyer.address}}{{product.buyer.address}}{{else}}<em>Not provided</em>{{/if}}</span>
          </div>
        </div>
      </div>
    </div>
    {{/if}}

    <!-- Related Customer Queries -->
    {{#if relatedQueries.length}}
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-chat-dots me-2"></i>Related Customer Queries</h5>
      <p class="text-muted mb-3">Customer queries related to this product's serial number</p>
      {{#each relatedQueries}}
      <div class="query-item mb-3 p-3" style="background: #f8f9fa; border-left: 4px solid var(--primary-color); border-radius: 0 8px 8px 0;">
        <div class="row">
          <div class="col-md-8">
            <h6 class="mb-2 text-primary">{{this.subject}}</h6>
            <p class="mb-2" style="font-size: 0.9em;">{{this.message}}</p>
          </div>
          <div class="col-md-4 text-md-end">
            <small class="text-muted">
              <i class="bi bi-envelope me-1"></i>{{this.email}}<br>
              <i class="bi bi-clock me-1"></i>{{formatDateTime this.createdAt}}
            </small>
          </div>
        </div>
        {{#if this.name}}
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-person me-1"></i><strong>From:</strong> {{this.name}}
          </small>
        </div>
        {{/if}}
      </div>
      {{/each}}
      <div class="text-center mt-3">
        <small class="text-muted">Showing latest 10 queries</small>
      </div>
    </div>
    {{else}}
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-chat-dots me-2"></i>Related Customer Queries</h5>
      <div class="text-center py-4">
        <i class="bi bi-chat-dots text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
        <p class="text-muted mt-2 mb-0">No customer queries found for this product</p>
        <small class="text-muted">Queries will appear here when customers submit queries with this product's serial number</small>
      </div>
    </div>
    {{/if}}
  </div>

  <div class="col-lg-4">
    <!-- Warranty Status -->
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-shield-check me-2"></i>Warranty Status</h5>
      {{#if product.warrantyRegistered}}
        <div class="text-center mb-3">
          <span class="warranty-badge {{#eq product.warranty.status 'active'}}warranty-active{{/eq}}{{#eq product.warranty.status 'expired'}}warranty-expired{{/eq}}{{#eq product.warranty.status 'void'}}warranty-void{{/eq}}">
            {{product.warranty.status}}
          </span>
        </div>
        <div class="detail-row">
          <small class="detail-label">Registration Date:</small><br>
          <small class="detail-value">{{formatDate product.warranty.registrationDate}}</small>
        </div>
        <div class="detail-row">
          <small class="detail-label">Expiry Date:</small><br>
          <small class="detail-value">{{formatDate product.warranty.expiryDate}}</small>
        </div>
        <div class="detail-row">
          <small class="detail-label">Duration:</small><br>
          <small class="detail-value">{{product.warranty.durationMonths}} months</small>
        </div>
        <div class="detail-row">
          <small class="detail-label">Registered By:</small><br>
          <small class="detail-value">{{product.warranty.registeredBy}}</small>
        </div>
        {{#if product.warranty.notes}}
        <div class="detail-row">
          <small class="detail-label">Notes:</small><br>
          <small class="detail-value">{{product.warranty.notes}}</small>
        </div>
        {{/if}}
        {{#if product.warranty.billFile}}
        <div class="text-center mt-3">
          <a href="/products/{{product._id}}/warranty/bill" target="_blank" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-file-earmark-pdf me-1"></i>View Bill
          </a>
        </div>
        {{/if}}
      {{else}}
        <div class="text-center">
          <span class="warranty-badge warranty-none">Not Registered</span>
          <p class="mt-3 text-muted">No warranty registered for this product</p>
          <button class="btn btn-sm btn-primary" onclick="showWarrantyModal()">
            <i class="bi bi-plus-circle me-1"></i>Register Warranty
          </button>
        </div>
      {{/if}}
    </div>

    <!-- Quick Actions -->
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
      <div class="d-grid gap-2">
        <a href="/products/{{product._id}}/edit" class="btn btn-outline-primary">
          <i class="bi bi-pencil me-2"></i>Edit Product
        </a>
        <button class="btn btn-outline-warning" onclick="showWarrantyModal()">
          <i class="bi bi-shield me-2"></i>Manage Warranty
        </button>
        <button class="btn btn-outline-info" onclick="copySerialNumber()">
          <i class="bi bi-clipboard me-2"></i>Copy Serial Number
        </button>
        <button class="btn btn-outline-danger" onclick="markAsReturn()">
          <i class="bi bi-arrow-return-left me-2"></i>Mark Return
        </button>
      </div>
    </div>

    <!-- Metadata -->
    <div class="detail-card">
      <h5 class="detail-header"><i class="bi bi-info-circle me-2"></i>System Information</h5>
      <div class="detail-row">
        <small class="detail-label">Product ID:</small><br>
        <small class="detail-value font-monospace">{{product._id}}</small>
      </div>
      <div class="detail-row">
        <small class="detail-label">Created At:</small><br>
        <small class="detail-value">{{formatDateTime product.createdAt}}</small>
      </div>
      <div class="detail-row">
        <small class="detail-label">Last Updated:</small><br>
        <small class="detail-value">{{formatDateTime product.updatedAt}}</small>
      </div>
    </div>
  </div>
</div>

<!-- Warranty Registration Modal -->
<div class="modal fade" id="warrantyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{#if product.warrantyRegistered}}Update Warranty{{else}}Register Warranty{{/if}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="warrantyForm" enctype="multipart/form-data">
        <div class="modal-body">
          
          <div class="mb-3">
            <label class="form-label">Warranty Duration (Months)</label>
            <select class="form-select" name="durationMonths" required>
              <option value="6">6 Months</option>
              <option value="12" selected>12 Months (1 Year)</option>
              <option value="24">24 Months (2 Years)</option>
              <option value="36">36 Months (3 Years)</option>
            </select>
          </div>

          {{#if product.warrantyRegistered}}
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="status">
              <option value="active" {{#eq product.warranty.status 'active'}}selected{{/eq}}>Active</option>
              <option value="expired" {{#eq product.warranty.status 'expired'}}selected{{/eq}}>Expired</option>
              <option value="void" {{#eq product.warranty.status 'void'}}selected{{/eq}}>Void</option>
            </select>
          </div>
          {{/if}}

          <div class="mb-3">
            <label class="form-label">Bill File {{#unless product.warrantyRegistered}}(Required){{/unless}}</label>
            <input type="file" class="form-control" name="billFile" accept="image/*,application/pdf" {{#unless product.warrantyRegistered}}required{{/unless}}>
            <small class="text-muted">Accept: Images (JPEG, PNG, GIF) and PDF. Max 10MB</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="notes" rows="3" placeholder="Optional notes about warranty"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span class="submit-text">{{#if product.warrantyRegistered}}Update{{else}}Register{{/if}} Warranty</span>
            <span class="submit-loading d-none">
              <span class="spinner-border spinner-border-sm me-2"></span>Processing...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{{#section 'script'}}
<script>
function showWarrantyModal() {
  const modal = new bootstrap.Modal(document.getElementById('warrantyModal'));
  modal.show();
}

function copySerialNumber() {
  const serialNumber = '{{product.serialNumber}}';
  navigator.clipboard.writeText(serialNumber).then(() => {
    showToast('success', 'Serial number copied to clipboard');
  }).catch(() => {
    showToast('error', 'Failed to copy serial number');
  });
}

function markAsReturn() {
  Swal.fire({
    title: 'Mark Product as Return',
    html: `
      <div class="text-start">
        <p><strong>Product:</strong> {{product.name}}</p>
        <p><strong>Serial:</strong> {{product.serialNumber}}</p>
        <hr>
        <div class="mb-3">
          <label for="returnReason" class="form-label">Return Reason <span class="text-danger">*</span></label>
          <select class="form-select" id="returnReason" required>
            <option value="">Select reason</option>
            <option value="defective">Defective Product</option>
            <option value="damaged">Damaged in Transit</option>
            <option value="wrong_item">Wrong Item Sent</option>
            <option value="customer_request">Customer Request</option>
            <option value="warranty_claim">Warranty Claim</option>
            <option value="quality_issue">Quality Issue</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="returnNotes" class="form-label">Additional Notes</label>
          <textarea class="form-control" id="returnNotes" rows="3" placeholder="Optional notes about the return..."></textarea>
        </div>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This action will permanently move the product to returns and cannot be undone.
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Mark as Return',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    width: '600px',
    preConfirm: () => {
      const reason = document.getElementById('returnReason').value;
      const notes = document.getElementById('returnNotes').value;
      
      if (!reason) {
        Swal.showValidationMessage('Please select a return reason');
        return false;
      }
      
      return {
        reason: reason,
        notes: notes
      };
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        // Show loading
        Swal.fire({
          title: 'Processing...',
          text: 'Marking product as return...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        const response = await fetch('/products/{{product._id}}/return', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            returnReason: result.value.reason,
            returnNotes: result.value.notes
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          Swal.fire({
            title: 'Success!',
            text: 'Product has been marked as return and moved to returns section.',
            icon: 'success',
            confirmButtonColor: '#28a745'
          }).then(() => {
            // Redirect to products list
            window.location.href = '/products';
          });
        } else {
          throw new Error(data.message || 'Failed to mark product as return');
        }
      } catch (error) {
        console.error('Return error:', error);
        Swal.fire({
          title: 'Error!',
          text: error.message || 'An error occurred while marking product as return',
          icon: 'error',
          confirmButtonColor: '#dc3545'
        });
      }
    }
  });
}

function showToast(type, message) {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed top-0 end-0 m-3" role="alert" style="z-index: 9999;">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', toastHtml);
  const toast = new bootstrap.Toast(document.querySelector('.toast:last-child'));
  toast.show();
  
  setTimeout(() => {
    document.querySelector('.toast:last-child')?.remove();
  }, 5000);
}

// Warranty form submission
document.getElementById('warrantyForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const submitText = submitBtn.querySelector('.submit-text');
  const submitLoading = submitBtn.querySelector('.submit-loading');
  
  submitBtn.disabled = true;
  submitText.classList.add('d-none');
  submitLoading.classList.remove('d-none');
  
  const formData = new FormData(this);
  
  try {
    const response = await fetch('/products/{{product._id}}/warranty', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('success', result.message);
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      showToast('error', result.message || 'Failed to process warranty');
      submitBtn.disabled = false;
      submitText.classList.remove('d-none');
      submitLoading.classList.add('d-none');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('error', 'An error occurred while processing warranty');
    submitBtn.disabled = false;
    submitText.classList.remove('d-none');
    submitLoading.classList.add('d-none');
  }
});

// Set current warranty values if editing
{{#if product.warrantyRegistered}}
document.querySelector('select[name="durationMonths"]').value = '{{product.warranty.durationMonths}}';
{{#if product.warranty.notes}}
document.querySelector('textarea[name="notes"]').value = `{{product.warranty.notes}}`;
{{/if}}
{{/if}}
</script>
{{/section}}
