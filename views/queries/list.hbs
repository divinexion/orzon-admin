{{#section 'style'}}
<style>
  .query-card {
    border: none;
    border-radius: 15px;
    transition: all 0.3s;
    overflow: hidden;
  }
  .query-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }
  .query-card .card-header {
    background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
    border-bottom: 2px solid rgba(102,126,234,0.2);
  }
  .badge-resolved {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
  }
  .badge-pending {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
  }
  .query-meta {
    font-size: 0.875rem;
    color: #6c757d;
  }
  .stats-overview {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 15px;
    padding: 1.5rem;
    color: white;
    margin-bottom: 2rem;
  }
  .search-box {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
</style>
{{/section}}

<div class="page-header mb-4">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="mb-0">Customer Queries</h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="/products">Dashboard</a></li>
          <li class="breadcrumb-item active">Queries</li>
        </ol>
      </nav>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="stats-overview">
      <div class="d-flex align-items-center">
        <i class="bi bi-chat-dots fs-1 me-3"></i>
        <div>
          <h3 class="mb-0">{{total}}</h3>
          <p class="mb-0 opacity-75">Total Queries</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="search-box">
  <form method="get" action="/queries">
    <div class="row g-3 align-items-end">
      <div class="col-md-10">
        <label class="form-label"><i class="bi bi-search me-2"></i>Search Queries</label>
        <input type="text" class="form-control form-control-lg" name="search" value="{{search}}" placeholder="Search by name, description, or serial number..." />
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary btn-lg w-100" type="submit">
          <i class="bi bi-search me-2"></i> Search
        </button>
      </div>
    </div>
  </form>
</div>

{{#if queries.length}}
  <div class="row g-4">
    {{#each queries}}
      <div class="col-lg-6 col-xl-4">
        <div class="card query-card h-100">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-bold text-truncate" style="max-width: 200px;" title="{{name}}">{{name}}</h6>
              {{#if isResolved}}
                <span class="badge badge-resolved">Resolved</span>
              {{else}}
                <span class="badge badge-pending">Pending</span>
              {{/if}}
            </div>
          </div>
          <div class="card-body">
            <p class="card-text" style="min-height: 3rem;">{{description}}</p>
            
            {{#if productSerialNumber}}
              <div class="d-flex align-items-center mb-3">
                <i class="bi bi-upc-scan text-muted me-2"></i>
                <div>
                  <small class="text-muted d-block">Product Serial</small>
                  <span class="fw-bold">{{productSerialNumber}}</span>
                </div>
              </div>
              {{#if product}}
                <div class="alert alert-light mb-3">
                  <small class="text-muted">Linked Product:</small>
                  <div class="fw-bold text-primary">{{product.name}}</div>
                  <small>Type: {{product.typeCapacity}} GB</small>
                </div>
              {{/if}}
            {{/if}}
            
            <div class="query-meta border-top pt-3">
              <div class="d-flex align-items-center mb-1">
                <i class="bi bi-calendar3 me-2"></i>
                <small>Submitted: {{formatDate createdAt}}</small>
              </div>
              {{#if isResolved}}
                <div class="d-flex align-items-center">
                  <i class="bi bi-check-circle text-success me-2"></i>
                  <small>Resolved: {{formatDate resolvedAt}}</small>
                </div>
              {{/if}}
            </div>
          </div>
          <div class="card-footer bg-transparent">
            <div class="d-grid gap-2">
              <a href="/queries/{{_id}}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-eye me-1"></i> View Details
              </a>
              <form method="post" action="/queries/{{_id}}/toggle-status">
                <button type="submit" class="btn btn-{{#if isResolved}}outline-warning{{else}}success{{/if}} btn-sm w-100">
                  {{#if isResolved}}
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Reopen
                  {{else}}
                    <i class="bi bi-check2-circle me-1"></i> Mark Resolved
                  {{/if}}
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {{/each}}
  </div>
  
  <div class="d-flex justify-content-center mt-4">
    {{{pagination pagination}}}
  </div>
{{else}}
  <div class="card">
    <div class="card-body text-center py-5">
      <i class="bi bi-chat-left-dots fs-1 text-muted mb-3 d-block"></i>
      <h4>No queries found</h4>
      <p class="text-muted">{{#if search}}Try adjusting your search criteria.{{else}}Queries submitted through the public API will appear here.{{/if}}</p>
      {{#unless search}}
        <div class="mt-4">
          <h6>API Endpoint for Queries:</h6>
          <code class="bg-light p-2 d-inline-block rounded">POST /api/queries</code>
        </div>
      {{/unless}}
    </div>
  </div>
{{/if}}

{{#section 'script'}}
<script>
// Loading state for search form
const searchForm = document.querySelector('form[action="/queries"]');
if (searchForm) {
  searchForm.addEventListener('submit', function(e) {
    const button = this.querySelector('button[type="submit"]');
    if (button) {
      button.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        Searching...
      `;
      button.disabled = true;
    }
    
    // Show loading in query cards area
    const queryContainer = document.querySelector('.row.g-4');
    if (queryContainer) {
      queryContainer.innerHTML = `
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5 class="text-muted">Searching queries...</h5>
        </div>
      `;
    }
  });
}

// Loading state for status toggle buttons
document.querySelectorAll('form[action*="toggle-status"]').forEach(form => {
  form.addEventListener('submit', function(e) {
    const button = this.querySelector('button[type="submit"]');
    if (button) {
      const originalContent = button.innerHTML;
      button.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status"></span>
      `;
      button.disabled = true;
      
      // Store original content for potential error recovery
      button.dataset.originalContent = originalContent;
    }
  });
});

// Loading state for view details links
document.querySelectorAll('a[href*="/queries/"]').forEach(link => {
  if (link.textContent.includes('View Details')) {
    link.addEventListener('click', function(e) {
      this.innerHTML = `
        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
        Loading...
      `;
      this.style.pointerEvents = 'none';
    });
  }
});

// Pagination loading
document.querySelectorAll('.pagination a').forEach(link => {
  link.addEventListener('click', function(e) {
    const queriesArea = document.querySelector('.row.g-4');
    if (queriesArea) {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
      overlay.style.background = 'rgba(0,0,0,0.3)';
      overlay.style.zIndex = '9999';
      overlay.innerHTML = `
        <div class="text-center text-white">
          <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5>Loading page...</h5>
        </div>
      `;
      document.body.appendChild(overlay);
    }
  });
});
</script>
{{/section}}
